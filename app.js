const EMBED = {"temas": [{"id": 20, "titulo": "A2 Â· Direcciones y transporte", "caracteres": [{"hanzi": "æ¥¼", "pinyin": "lÃ³u"}, {"hanzi": "é‚®", "pinyin": "yÃ³u"}, {"hanzi": "å±€", "pinyin": "jÃº"}, {"hanzi": "å", "pinyin": "hÃ²u"}, {"hanzi": "è¾¹", "pinyin": "biÄn"}, {"hanzi": "å¾€", "pinyin": "wÇng"}, {"hanzi": "å—", "pinyin": "nÃ¡n"}, {"hanzi": "è¿‘", "pinyin": "jÃ¬n"}, {"hanzi": "é“¶", "pinyin": "yÃ­n"}, {"hanzi": "è¡Œ", "pinyin": "hÃ¡ng"}, {"hanzi": "å‰", "pinyin": "qiÃ¡n"}, {"hanzi": "é’Ÿ", "pinyin": "zhÅng"}, {"hanzi": "å·¦", "pinyin": "zuÇ’"}, {"hanzi": "å³", "pinyin": "yÃ²u"}, {"hanzi": "å‡º", "pinyin": "chÅ«"}, {"hanzi": "ç§Ÿ", "pinyin": "zÅ«"}, {"hanzi": "æˆ¿", "pinyin": "fÃ¡ng"}, {"hanzi": "ä¸œ", "pinyin": "dÅng"}, {"hanzi": "è¥¿", "pinyin": "xÄ«"}, {"hanzi": "åœ°", "pinyin": "dÃ¬"}, {"hanzi": "é“", "pinyin": "tiÄ›"}, {"hanzi": "ç«™", "pinyin": "zhÃ n"}, {"hanzi": "åŒ—", "pinyin": "bÄ›i"}, {"hanzi": "äº¤", "pinyin": "jiÄo"}, {"hanzi": "é€š", "pinyin": "tÅng"}, {"hanzi": "æ–¹", "pinyin": "fÄng"}, {"hanzi": "ä¾¿", "pinyin": "biÃ n"}, {"hanzi": "è”", "pinyin": "liÃ¡n"}, {"hanzi": "ç³»", "pinyin": "xÃ¬"}, {"hanzi": "å¹³", "pinyin": "pÃ­ng"}, {"hanzi": "ç±³", "pinyin": "mÇ"}, {"hanzi": "é¥­", "pinyin": "fÃ n"}, {"hanzi": "é¦†", "pinyin": "guÇn"}, {"hanzi": "æ´—", "pinyin": "xÇ"}, {"hanzi": "å•†", "pinyin": "shÄng"}, {"hanzi": "è¯", "pinyin": "yÃ o"}, {"hanzi": "åº—", "pinyin": "diÃ n"}, {"hanzi": "è­¦", "pinyin": "jÇng"}, {"hanzi": "å¯Ÿ", "pinyin": "chÃ¡"}, {"hanzi": "å®ƒ", "pinyin": "tÄ"}, {"hanzi": "è‰²", "pinyin": "sÃ¨"}, {"hanzi": "éœ€", "pinyin": "xÅ«"}, {"hanzi": "è¦", "pinyin": "yÃ o"}, {"hanzi": "äº›", "pinyin": "xiÄ“"}, {"hanzi": "å", "pinyin": "zuÃ²"}, {"hanzi": "å…¬", "pinyin": "gÅng"}, {"hanzi": "å…±", "pinyin": "gÃ²ng"}, {"hanzi": "æ±½", "pinyin": "qÃ¬"}, {"hanzi": "è½¦", "pinyin": "chÄ“"}, {"hanzi": "è¿˜", "pinyin": "hÃ¡i"}, {"hanzi": "æ˜¯", "pinyin": "shÃ¬"}, {"hanzi": "ç„¶", "pinyin": "rÃ¡n"}, {"hanzi": "å½“", "pinyin": "dÄng"}, {"hanzi": "é¤", "pinyin": "cÄn"}, {"hanzi": "å…", "pinyin": "tÄ«ng"}, {"hanzi": "æ—…", "pinyin": "lÇš"}, {"hanzi": "è¡Œ", "pinyin": "xÃ­ng"}, {"hanzi": "æš‘", "pinyin": "shÇ”"}, {"hanzi": "å‡", "pinyin": "jiÃ "}, {"hanzi": "ç¬¬", "pinyin": "dÃ¬"}, {"hanzi": "ç«", "pinyin": "huÇ’"}, {"hanzi": "èˆ¹", "pinyin": "chuÃ¡n"}, {"hanzi": "çˆ¬", "pinyin": "pÃ¡"}, {"hanzi": "å±±", "pinyin": "shÄn"}, {"hanzi": "æ‹", "pinyin": "pÄi"}, {"hanzi": "ç…§", "pinyin": "zhÃ o"}, {"hanzi": "æ™¯", "pinyin": "jÇng"}, {"hanzi": "ç‚¹", "pinyin": "diÇn"}, {"hanzi": "éª‘", "pinyin": "qÃ­"}, {"hanzi": "è‡ª", "pinyin": "zÃ¬"}, {"hanzi": "é£", "pinyin": "fÄ“i"}, {"hanzi": "æœº", "pinyin": "jÄ«"}, {"hanzi": "åœº", "pinyin": "chÇng"}, {"hanzi": "å®¢", "pinyin": "kÃ¨"}, {"hanzi": "è¿", "pinyin": "yÃ¹n"}], "vocabulario": [{"hanzi": "é‚®å±€", "pinyin": "yÃ³ujÃº", "es": "oficina de correos", "frase_zh": "é‚®å±€åœ¨é“¶è¡Œæ—è¾¹ã€‚", "frase_es": "La oficina de correos estÃ¡ al lado del banco.", "tokens": ["é‚®å±€", "åœ¨", "é“¶è¡Œ", "æ—è¾¹", "ã€‚"]}, {"hanzi": "é“¶è¡Œ", "pinyin": "yÃ­nhÃ¡ng", "es": "banco", "frase_zh": "æˆ‘å»é“¶è¡Œå–é’±ã€‚", "frase_es": "Voy al banco a sacar dinero.", "tokens": ["æˆ‘", "å»", "é“¶è¡Œ", "å–é’±", "ã€‚"]}, {"hanzi": "åšç‰©é¦†", "pinyin": "bÃ³wÃ¹guÇn", "es": "museo", "frase_zh": "åšç‰©é¦†å¾ˆæœ‰åã€‚", "frase_es": "El museo es famoso.", "tokens": ["åšç‰©é¦†", "å¾ˆ", "æœ‰å", "ã€‚"]}, {"hanzi": "å›¾ä¹¦é¦†", "pinyin": "tÃºshÅ«guÇn", "es": "biblioteca", "frase_zh": "å›¾ä¹¦é¦†åœ¨å­¦æ ¡æ—è¾¹ã€‚", "frase_es": "La biblioteca estÃ¡ al lado de la escuela.", "tokens": ["å›¾ä¹¦é¦†", "åœ¨", "å­¦æ ¡", "æ—è¾¹", "ã€‚"]}, {"hanzi": "å¹¿åœº", "pinyin": "guÇngchÇng", "es": "plaza", "frase_zh": "å¹¿åœºåœ¨å¸‚ä¸­å¿ƒã€‚", "frase_es": "La plaza estÃ¡ en el centro de la ciudad.", "tokens": ["å¹¿åœº", "åœ¨", "å¸‚ä¸­å¿ƒ", "ã€‚"]}], "huecos_bank": [{"target": "æ—è¾¹", "frase_es": "La oficina de correos estÃ¡ al lado del banco.", "tokens": ["é‚®å±€", "åœ¨", "é“¶è¡Œ", "æ—è¾¹", "ã€‚"], "distractores": ["å‰é¢", "åé¢", "ä¸­é—´"]}, {"target": "æœ‰å", "frase_es": "El museo es famoso.", "tokens": ["åšç‰©é¦†", "å¾ˆ", "æœ‰å", "ã€‚"], "distractores": ["æ–¹ä¾¿", "éœ€è¦", "å‡ºç§Ÿ"]}], "gramatica": [{"es": "Camina recto y gira a la izquierda en la primera intersecciÃ³n.", "zh": "ä¸€ç›´å¾€å‰èµ°ï¼Œåœ¨ç¬¬ä¸€ä¸ªè·¯å£å¾€å·¦æ‹ã€‚", "tokens": ["ä¸€ç›´", "å¾€", "å‰", "èµ°", "ï¼Œ", "åœ¨", "ç¬¬", "ä¸€ä¸ª", "è·¯å£", "å¾€", "å·¦", "æ‹", "ã€‚"]}, {"es": "Gira a la derecha en la segunda intersecciÃ³n.", "zh": "åœ¨ç¬¬äºŒä¸ªè·¯å£å¾€å³æ‹ã€‚", "tokens": ["åœ¨", "ç¬¬", "äºŒ", "ä¸ª", "è·¯å£", "å¾€", "å³", "æ‹", "ã€‚"]}, {"es": "Mira hacia la derecha y cruza la calle.", "zh": "å¾€å³çœ‹ï¼Œè¿‡é©¬è·¯ã€‚", "tokens": ["å¾€", "å³", "çœ‹", "ï¼Œ", "è¿‡", "é©¬è·¯", "ã€‚"]}, {"es": "Corre hacia adelante y en el tercer cruce gira a la derecha.", "zh": "å¾€å‰è·‘ï¼Œåˆ°ç¬¬ä¸‰ä¸ªè·¯å£å³æ‹ã€‚", "tokens": ["å¾€", "å‰", "è·‘", "ï¼Œ", "åˆ°", "ç¬¬", "ä¸‰", "ä¸ª", "è·¯å£", "å³", "æ‹", "ã€‚"]}, {"es": "El supermercado estÃ¡ delante de la oficina de correos.", "zh": "è¶…å¸‚åœ¨é‚®å±€çš„å‰é¢ã€‚", "tokens": ["è¶…å¸‚", "åœ¨", "é‚®å±€", "çš„", "å‰é¢", "ã€‚"]}, {"es": "El parque estÃ¡ detrÃ¡s de el supermercado.", "zh": "å…¬å›­åœ¨è¶…å¸‚çš„åé¢ã€‚", "tokens": ["å…¬å›­", "åœ¨", "è¶…å¸‚", "çš„", "åé¢", "ã€‚"]}, {"es": "El parque estÃ¡ delante de la farmacia.", "zh": "å…¬å›­åœ¨è¯åº—çš„å‰é¢ã€‚", "tokens": ["å…¬å›­", "åœ¨", "è¯åº—", "çš„", "å‰é¢", "ã€‚"]}, {"es": "La oficina de correos estÃ¡ encima de el museo.", "zh": "é‚®å±€åœ¨åšç‰©é¦†çš„ä¸Šé¢ã€‚", "tokens": ["é‚®å±€", "åœ¨", "åšç‰©é¦†", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "La oficina de correos estÃ¡ encima de el aparcamiento.", "zh": "é‚®å±€åœ¨åœè½¦åœºçš„ä¸Šé¢ã€‚", "tokens": ["é‚®å±€", "åœ¨", "åœè½¦åœº", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "El museo estÃ¡ encima de la biblioteca.", "zh": "åšç‰©é¦†åœ¨å›¾ä¹¦é¦†çš„ä¸Šé¢ã€‚", "tokens": ["åšç‰©é¦†", "åœ¨", "å›¾ä¹¦é¦†", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "La biblioteca estÃ¡ a la derecha de el hotel.", "zh": "å›¾ä¹¦é¦†åœ¨å®¾é¦†çš„å³è¾¹ã€‚", "tokens": ["å›¾ä¹¦é¦†", "åœ¨", "å®¾é¦†", "çš„", "å³è¾¹", "ã€‚"]}, {"es": "El supermercado estÃ¡ a la izquierda de el museo.", "zh": "è¶…å¸‚åœ¨åšç‰©é¦†çš„å·¦è¾¹ã€‚", "tokens": ["è¶…å¸‚", "åœ¨", "åšç‰©é¦†", "çš„", "å·¦è¾¹", "ã€‚"]}, {"es": "La tienda estÃ¡ encima de la plaza.", "zh": "å•†åº—åœ¨å¹¿åœºçš„ä¸Šé¢ã€‚", "tokens": ["å•†åº—", "åœ¨", "å¹¿åœº", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "El supermercado estÃ¡ debajo de la estaciÃ³n.", "zh": "è¶…å¸‚åœ¨è½¦ç«™çš„ä¸‹é¢ã€‚", "tokens": ["è¶…å¸‚", "åœ¨", "è½¦ç«™", "çš„", "ä¸‹é¢", "ã€‚"]}, {"es": "El baÃ±o estÃ¡ encima de el parque.", "zh": "æ´—æ‰‹é—´åœ¨å…¬å›­çš„ä¸Šé¢ã€‚", "tokens": ["æ´—æ‰‹é—´", "åœ¨", "å…¬å›­", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "La tienda estÃ¡ a la derecha de la estaciÃ³n de metro.", "zh": "å•†åº—åœ¨åœ°é“ç«™çš„å³è¾¹ã€‚", "tokens": ["å•†åº—", "åœ¨", "åœ°é“ç«™", "çš„", "å³è¾¹", "ã€‚"]}, {"es": "El hotel estÃ¡ a la izquierda de el parque.", "zh": "å®¾é¦†åœ¨å…¬å›­çš„å·¦è¾¹ã€‚", "tokens": ["å®¾é¦†", "åœ¨", "å…¬å›­", "çš„", "å·¦è¾¹", "ã€‚"]}, {"es": "El ascensor estÃ¡ debajo de el parque.", "zh": "ç”µæ¢¯åœ¨å…¬å›­çš„ä¸‹é¢ã€‚", "tokens": ["ç”µæ¢¯", "åœ¨", "å…¬å›­", "çš„", "ä¸‹é¢", "ã€‚"]}, {"es": "La biblioteca estÃ¡ delante de el parque.", "zh": "å›¾ä¹¦é¦†åœ¨å…¬å›­çš„å‰é¢ã€‚", "tokens": ["å›¾ä¹¦é¦†", "åœ¨", "å…¬å›­", "çš„", "å‰é¢", "ã€‚"]}, {"es": "El aparcamiento estÃ¡ detrÃ¡s de la escuela.", "zh": "åœè½¦åœºåœ¨å­¦æ ¡çš„åé¢ã€‚", "tokens": ["åœè½¦åœº", "åœ¨", "å­¦æ ¡", "çš„", "åé¢", "ã€‚"]}, {"es": "La tienda estÃ¡ debajo de el aparcamiento.", "zh": "å•†åº—åœ¨åœè½¦åœºçš„ä¸‹é¢ã€‚", "tokens": ["å•†åº—", "åœ¨", "åœè½¦åœº", "çš„", "ä¸‹é¢", "ã€‚"]}, {"es": "La estaciÃ³n estÃ¡ al lado de el aeropuerto.", "zh": "è½¦ç«™åœ¨æœºåœºçš„æ—è¾¹ã€‚", "tokens": ["è½¦ç«™", "åœ¨", "æœºåœº", "çš„", "æ—è¾¹", "ã€‚"]}, {"es": "El parque estÃ¡ delante de el aparcamiento.", "zh": "å…¬å›­åœ¨åœè½¦åœºçš„å‰é¢ã€‚", "tokens": ["å…¬å›­", "åœ¨", "åœè½¦åœº", "çš„", "å‰é¢", "ã€‚"]}, {"es": "La farmacia estÃ¡ delante de el parque.", "zh": "è¯åº—åœ¨å…¬å›­çš„å‰é¢ã€‚", "tokens": ["è¯åº—", "åœ¨", "å…¬å›­", "çš„", "å‰é¢", "ã€‚"]}, {"es": "El banco estÃ¡ delante de la escuela.", "zh": "é“¶è¡Œåœ¨å­¦æ ¡çš„å‰é¢ã€‚", "tokens": ["é“¶è¡Œ", "åœ¨", "å­¦æ ¡", "çš„", "å‰é¢", "ã€‚"]}, {"es": "El aparcamiento estÃ¡ en el medio de la biblioteca.", "zh": "åœè½¦åœºåœ¨å›¾ä¹¦é¦†çš„ä¸­é—´ã€‚", "tokens": ["åœè½¦åœº", "åœ¨", "å›¾ä¹¦é¦†", "çš„", "ä¸­é—´", "ã€‚"]}, {"es": "El banco estÃ¡ delante de el museo.", "zh": "é“¶è¡Œåœ¨åšç‰©é¦†çš„å‰é¢ã€‚", "tokens": ["é“¶è¡Œ", "åœ¨", "åšç‰©é¦†", "çš„", "å‰é¢", "ã€‚"]}, {"es": "La plaza estÃ¡ al lado de el ascensor.", "zh": "å¹¿åœºåœ¨ç”µæ¢¯çš„æ—è¾¹ã€‚", "tokens": ["å¹¿åœº", "åœ¨", "ç”µæ¢¯", "çš„", "æ—è¾¹", "ã€‚"]}, {"es": "El aeropuerto estÃ¡ delante de el aparcamiento.", "zh": "é£æœºåœºåœ¨åœè½¦åœºçš„å‰é¢ã€‚", "tokens": ["é£æœºåœº", "åœ¨", "åœè½¦åœº", "çš„", "å‰é¢", "ã€‚"]}, {"es": "La tienda estÃ¡ debajo de la biblioteca.", "zh": "å•†åº—åœ¨å›¾ä¹¦é¦†çš„ä¸‹é¢ã€‚", "tokens": ["å•†åº—", "åœ¨", "å›¾ä¹¦é¦†", "çš„", "ä¸‹é¢", "ã€‚"]}, {"es": "El ascensor estÃ¡ detrÃ¡s de la oficina de correos.", "zh": "ç”µæ¢¯åœ¨é‚®å±€çš„åé¢ã€‚", "tokens": ["ç”µæ¢¯", "åœ¨", "é‚®å±€", "çš„", "åé¢", "ã€‚"]}, {"es": "La oficina de correos estÃ¡ en el medio de el aparcamiento.", "zh": "é‚®å±€åœ¨åœè½¦åœºçš„ä¸­é—´ã€‚", "tokens": ["é‚®å±€", "åœ¨", "åœè½¦åœº", "çš„", "ä¸­é—´", "ã€‚"]}, {"es": "El aeropuerto estÃ¡ al lado de la plaza.", "zh": "æœºåœºåœ¨å¹¿åœºçš„æ—è¾¹ã€‚", "tokens": ["æœºåœº", "åœ¨", "å¹¿åœº", "çš„", "æ—è¾¹", "ã€‚"]}, {"es": "El ascensor estÃ¡ encima de la plaza.", "zh": "ç”µæ¢¯åœ¨å¹¿åœºçš„ä¸Šé¢ã€‚", "tokens": ["ç”µæ¢¯", "åœ¨", "å¹¿åœº", "çš„", "ä¸Šé¢", "ã€‚"]}, {"es": "Voy a echar un vistazo al libro.", "zh": "æˆ‘çœ‹çœ‹ä¹¦ã€‚", "tokens": ["æˆ‘", "çœ‹çœ‹", "ä¹¦", "ã€‚"]}, {"es": "Ã‰chale un vistazo a esto.", "zh": "ä½ çœ‹ä¸€çœ‹è¿™ä¸ªã€‚", "tokens": ["ä½ ", "çœ‹ä¸€çœ‹", "è¿™ä¸ª", "ã€‚"]}, {"es": "Descansa un poco.", "zh": "ä¼‘æ¯ä¼‘æ¯å§ã€‚", "tokens": ["ä¼‘æ¯ä¼‘æ¯", "å§", "ã€‚"]}]}]};

const state={contenido:EMBED,temaActual:EMBED.temas[0],seleccion:{tipo:null,modo:null}};

function h(tag,props={},children=[]){const el=document.createElement(tag);for(const[k,v]of Object.entries(props)){if(k==='class')el.className=v;else if(k.startsWith('on'))el.addEventListener(k.slice(2).toLowerCase(),v);else el.setAttribute(k, v)}(Array.isArray(children)?children:[children]).forEach(c=>{if(typeof c==='string')el.appendChild(document.createTextNode(c));else if(c)el.appendChild(c)});return el}
function mount(n){const app=document.getElementById('app');app.innerHTML='';app.appendChild(n)}
function header(){return h('div',{class:'header container'},[h('div',{class:'logo'},'Sg'),h('div',{},[h('h1',{},'Segolingo')])])}

function home(){const tipos=h('div',{class:'grid'},[
  tipoCard('PrÃ¡ctica de Caracteres','caracteres',[submodoRadio('caracteres','hanzi_pinyin','Hanzi â†’ pinyin'),submodoRadio('caracteres','pinyin_hanzi','Pinyin â†’ hanzi')]),
  tipoCard('PrÃ¡ctica de Vocabulario','vocabulario',[submodoRadio('vocabulario','huecos','Rellenar huecos'),submodoRadio('vocabulario','parejas','Enlazar palabras')]),
  tipoCard('PrÃ¡ctica de GramÃ¡tica','gramatica',[submodoRadio('gramatica','ordenar','Ordenar palabras')])
]);
const empezarBtn=h('button',{class:'button',onClick:start},'Empezar');
return h('div',{},[header(),h('div',{class:'container grid'},[
  h('div',{class:'card'},[h('div',{class:'section-title'},'Tipo de prueba'),tipos,h('div',{style:'margin-top:12px;'},empezarBtn)])
])]);}
function submodoRadio(tipo,valor,label){const id=`${tipo}-${valor}`;const input=h('input',{type:'radio',name:`modo-${tipo}`,id,value:valor});input.addEventListener('change',()=>{state.seleccion.tipo=tipo;state.seleccion.modo=valor});const lab=h('label',{for:id},label);return h('div',{},[input,lab])}
function tipoCard(titulo,tipo,children){return h('div',{class:'card'},[h('h3',{},titulo),...children])}
function start(){const {tipo,modo}=state.seleccion; if(!tipo||!modo){alert('Selecciona tipo y modo de prueba');return} if(tipo==='caracteres')mount(caracteresChoiceUI(modo)); if(tipo==='vocabulario')mount(vocabularioUI(modo)); if(tipo==='gramatica')mount(gramaticaUI(modo))}

function shuffle(arr){const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a}
function arraysEqual(a,b){if(a.length!==b.length)return false; for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false; return true}
function emptyUI(msg){return h('div',{},[header(),h('div',{class:'container card'},[h('p',{},msg),h('button',{class:'button ghost',onClick:()=>render()},'Volver')])])}
function render(){mount(home())}

// ========= 1) Caracteres =========
function extraerMonosilabos(){const base=state.temaActual?.caracteres||[]; return base.filter(x=> (x.hanzi||'').length===1 && !(x.pinyin||'').includes(' '));}
function caracteresChoiceUI(modo){ const pool=extraerMonosilabos(); if(pool.length<4) return emptyUI('No hay suficientes caracteres monosilÃ¡bicos'); let ronda=shuffle(pool).slice(0, Math.min(10, pool.length)); let idx=0; let aciertos=0, errores=0; let colaFallos=[]; const fallosDetalle=new Map(); const cont=h('div',{class:'container'});
  function fin(){ cont.innerHTML=''; cont.appendChild(h('h2',{},'Informe de sesiÃ³n')); const rep=h('div',{class:'report'}); rep.appendChild(h('div',{},`âœ”ï¸ Aciertos: ${aciertos} Â· âŒ Errores: ${errores}`)); const ul=h('ul',{}); if(fallosDetalle.size){ rep.appendChild(h('div',{},'Preguntas falladas (al menos una vez):')); for(const [key,count] of fallosDetalle){ const p=key.split('|'); ul.appendChild(h('li',{},`${p[0]} Â· prompt: ${p[1]} Â· correcta: ${p[2]} Â· intentos fallidos: ${count}`)); } } else { ul.appendChild(h('li',{},'No hubo fallos.')); } rep.appendChild(ul); rep.appendChild(h('button',{class:'button',onClick:()=>render()},'Volver')); cont.appendChild(rep); }
  function siguiente(){ let item=null; if(idx<ronda.length){ item=ronda[idx++]; } else if(colaFallos.length){ item=colaFallos.shift(); } else { return fin(); } cont.innerHTML=''; if(modo==='hanzi_pinyin'){ cont.appendChild(h('div',{class:'char-big'}, item.hanzi)); const opciones=crearOpciones(item.pinyin, pool.map(p=>p.pinyin)); cont.appendChild(opcionesGrid(opciones,(val,btn)=>{ if(val===item.pinyin){ aciertos++; btn.classList.add('correct'); setTimeout(siguiente,250);} else { errores++; btn.classList.add('wrong'); const k=`${modo}|${item.hanzi}|${item.pinyin}`; fallosDetalle.set(k,(fallosDetalle.get(k)||0)+1); colaFallos.push(item); setTimeout(siguiente,350);} }, false)); } else { cont.appendChild(h('div',{class:'pinyin-big'}, item.pinyin)); const opciones=crearOpciones(item.hanzi, pool.map(p=>p.hanzi)); cont.appendChild(opcionesGrid(opciones,(val,btn)=>{ if(val===item.hanzi){ aciertos++; btn.classList.add('correct'); setTimeout(siguiente,250);} else { errores++; btn.classList.add('wrong'); const k=`${modo}|${item.pinyin}|${item.hanzi}`; fallosDetalle.set(k,(fallosDetalle.get(k)||0)+1); colaFallos.push(item); setTimeout(siguiente,350);} }, true)); } cont.appendChild(h('div',{style:'margin-top:12px'}, h('button',{class:'button ghost',onClick:()=>render()},'Volver'))); }
  siguiente(); return h('div',{},[header(),cont]) }
function crearOpciones(correcta, universo){const distractores=shuffle(universo.filter(v=>v!==correcta)).slice(0,3); return shuffle([correcta,...distractores])}
function opcionesGrid(valores,onPick,hanziMode){const grid=h('div',{class:'option-grid'}); valores.forEach(v=>{const cls=hanziMode?'option hanzi-option':'option'; const btn=h('div',{class:cls,onClick:(e)=>onPick(v,e.currentTarget)}, v); grid.appendChild(btn)}); return grid}

// ========= 2) Vocabulario =========
function vocabularioUI(modo){ if(modo==='huecos') return huecosUI(); if(modo==='parejas') return parejasUI(); return emptyUI('Modo de vocabulario desconocido') }
function huecosUI(){ const bank = state.temaActual?.huecos_bank || []; if(bank.length<4) return emptyUI('No hay suficientes frases'); let items = shuffle(bank).slice(0,10); let idx=0; let aciertos=0, errores=0; const cont=h('div',{class:'container'}); const feedback=h('div',{class:'feedback'}); function fin(){ cont.innerHTML=''; cont.appendChild(h('h2',{},'Informe de sesiÃ³n')); cont.appendChild(h('div',{class:'report'},`âœ”ï¸ Aciertos: ${aciertos} Â· âŒ Errores: ${errores}`)); cont.appendChild(h('button',{class:'button',onClick:()=>render()},'Volver')); } function paso(){ if(idx>=items.length) return fin(); const it=items[idx++]; cont.innerHTML=''; feedback.textContent=''; feedback.className='feedback'; cont.appendChild(h('h2',{},'Rellenar huecos')); cont.appendChild(h('p',{}, it.frase_es || '')); const tokens=it.tokens.slice(); const pick = tokens.findIndex(t=> t===it.target); const correcta=tokens[pick]; const fraseConHueco=tokens.map((t,j)=> j===pick ? '____' : t).join(' '); cont.appendChild(h('p',{class:'card'},fraseConHueco)); const baseDistr = (it.distractores||[]).filter(d=> d!==correcta && !tokens.includes(d)); let opciones = shuffle([correcta, ...baseDistr.slice(0,3)]); const safePool = ["é—®é¢˜","å…´è¶£","é¼»å­","è€³æœµ","çš®è‚¤","èº«æ","å¥³å­©","è¤è‰²","è„¸","å˜´","ä¿©","å¦","æ›´","çŸ­","çŸ®","é‡è¦","ä¸­ç­‰","æœ€è¿‘","è‹—æ¡","èƒ–"]; let i=0; while(opciones.length<4 && i<safePool.length){ const cand=safePool[i++]; if(cand!==correcta && !tokens.includes(cand) && !opciones.includes(cand)) opciones.push(cand); } const box=h('div',{class:'grid'}); opciones.forEach(op=> box.appendChild(h('button',{class:'button ghost',onClick:()=>{ if(op===correcta){ aciertos++; feedback.className='feedback ok'; feedback.textContent='âœ”ï¸ Correcto'; setTimeout(paso,350);} else { errores++; feedback.className='feedback err'; feedback.textContent='âŒ Incorrecto'; } }}, op)) ); cont.appendChild(box); cont.appendChild(feedback); cont.appendChild(h('div',{style:'margin-top:12px'}, [h('button',{class:'button ghost',onClick:()=>render()},'Volver')])); } paso(); return h('div',{},[header(),cont]) }

function parejasUI(){ const items=state.temaActual?.vocabulario||[]; if(items.length<1) return emptyUI('No hay vocabulario para emparejar'); const sample=shuffle(items).slice(0,6); let izquierda=shuffle(sample.map((v,i)=>({ id:'L'+i, text:v.hanzi, key:i }))); let derecha=shuffle(sample.map((v,i)=>({ id:'R'+i, text:v.es, key:i }))); let seleccion={left:null,right:null}; let leftSelEl=null, rightSelEl=null; const leftList=h('div',{class:'list'}); const rightList=h('div',{class:'list'}); const feedback=h('div',{class:'feedback'}); function onClickSide(item, side, el){ if(side==='left'){ if(seleccion.left && seleccion.left.id===item.id){ seleccion.left=null; if(leftSelEl) leftSelEl.className='list-item'; leftSelEl=null; return; } seleccion.left=item; if(leftSelEl) leftSelEl.className='list-item'; leftSelEl=el; el.className='list-item selected'; } else { if(seleccion.right && seleccion.right.id===item.id){ seleccion.right=null; if(rightSelEl) rightSelEl.className='list-item'; rightSelEl=null; return; } seleccion.right=item; if(rightSelEl) rightSelEl.className='list-item'; rightSelEl=el; el.className='list-item selected'; } if(seleccion.left && seleccion.right){ if(seleccion.left.key===seleccion.right.key){ feedback.className='feedback ok'; feedback.textContent='âœ”ï¸ Â¡Bien!'; const remove=(arr,id)=>arr.splice(arr.findIndex(x=>x.id===id),1); remove(izquierda,seleccion.left.id); remove(derecha,seleccion.right.id); seleccion={left:null,right:null}; leftSelEl=null; rightSelEl=null; renderLists(); if(!izquierda.length) feedback.textContent='ğŸ‰ Â¡Has completado todas las parejas!'; } else { feedback.className='feedback err'; feedback.textContent='âŒ No es la pareja correcta'; } } } function renderLists(){ leftList.innerHTML=''; izquierda.forEach(item=>{ const el=h('div',{class:'list-item', onClick:()=>onClickSide(item,'left',el)}, item.text); leftList.appendChild(el) }); rightList.innerHTML=''; derecha.forEach(item=>{ const el=h('div',{class:'list-item', onClick:()=>onClickSide(item,'right',el)}, item.text); rightList.appendChild(el) }); } renderLists(); return h('div',{},[header(), h('div',{class:'container'},[ h('h2',{},'Enlazar palabras con su significado'), h('div',{class:'list-columns'},[leftList,rightList]), feedback, h('div',{style:'margin-top:12px'}, [h('button',{class:'button ghost',onClick:()=>render()},'Volver')]) ])]); }

// ========= 3) GramÃ¡tica =========
function gramaticaUI(modo){ if(modo!=='ordenar') return emptyUI('Modo de gramÃ¡tica desconocido'); const items=shuffle(state.temaActual?.gramatica||[]).slice(0,10); if(!items.length) return emptyUI('No hay ejercicios de gramÃ¡tica'); let idx=0; let aciertos=0, errores=0; const cont=h('div',{class:'container'}); const feedback=h('div',{class:'feedback'}); function fin(){ cont.innerHTML=''; cont.appendChild(h('h2',{},'Informe de sesiÃ³n')); cont.appendChild(h('div',{class:'report'},`âœ”ï¸ Aciertos: ${aciertos} Â· âŒ Errores: ${errores}`)); cont.appendChild(h('button',{class:'button',onClick:()=>render()},'Volver')); } function renderStep(){ if(idx>=items.length) return fin(); const it=items[idx++]; cont.innerHTML=''; feedback.textContent=''; feedback.className='feedback'; cont.appendChild(h('h2',{},'Ordenar palabras')); cont.appendChild(h('p',{},'Frase en espaÃ±ol: '+it.es)); const tokens=it.tokens.slice(); const correct=tokens.slice(); const poolItems=shuffle(tokens.map((tk,ix)=>({text:tk,id:ix}))); const builder=h('div',{id:'sentence-builder'}); const pool=h('div',{class:'grid'}); const chosen=[]; function addToBuilder(itm){ if(chosen.includes(itm.id)) return; chosen.push(itm.id); const sp=h('span',{class:'token selected', onClick:()=>{ const ix=chosen.indexOf(itm.id); if(ix>-1){ chosen.splice(ix,1); sp.remove(); const poolBtn=pool.querySelector(`[data-id="${itm.id}"]`); if(poolBtn) poolBtn.className='token'; } }}, itm.text); builder.appendChild(sp); const pb=pool.querySelector(`[data-id="${itm.id}"]`); if(pb) pb.className='token selected'; } poolItems.forEach(itm=>{ const btn=h('button',{class:'token','data-id':String(itm.id), onClick:()=>{ if(chosen.includes(itm.id)){ const ix=chosen.indexOf(itm.id); if(ix>-1) chosen.splice(ix,1); const spans=[...builder.querySelectorAll('.token.selected')]; const sp=spans.find(s=>s.textContent===itm.text); if(sp) sp.remove(); btn.className='token'; } else { addToBuilder(itm); } }}, itm.text); pool.appendChild(btn); }); cont.appendChild(pool); cont.appendChild(h('div',{class:'section-title'},'Tu frase:')); cont.appendChild(builder); const acciones=h('div',{style:'margin-top:12px'},[ h('button',{class:'button',onClick:()=>{ const chosenTexts=chosen.map(id=>tokens[id]); if(arraysEqual(chosenTexts, correct)){ aciertos++; feedback.className='feedback ok'; feedback.textContent='âœ”ï¸ Â¡Correcto!'; setTimeout(renderStep,450); } else { errores++; feedback.className='feedback err'; feedback.textContent='âŒ Comprueba el orden'; } }}, 'Comprobar'), h('button',{class:'button ghost',onClick:()=>{ renderStep(); }}, 'Siguiente'), h('button',{class:'button ghost',onClick:()=>render()}, 'Volver') ]); cont.appendChild(feedback); cont.appendChild(acciones); } renderStep(); return h('div',{},[header(),cont]); }

render();
